<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Edit Connector - {{ connector.get('name', '') }}</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: "Segoe UI", Arial, sans-serif;
      min-height: 100vh;
      background: linear-gradient(135deg, #f0f4f8, #dfe9f3);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 2rem;
      color: #333;
    }

    form {
      background: #fff;
      padding: 25px 30px;
      border-radius: 12px;
      width: 100%;
      max-width: 500px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
      animation: fadeIn 0.4s ease;
    }

    .form-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

    .form-header h1 {
      color: #2c3e50;
      font-size: 1.3rem;
      margin: 0;
    }

    .back-btn {
      background: #ecf0f1;
      color: #2c3e50;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 600;
      padding: 6px 12px;
      transition: background 0.2s, transform 0.1s;
    }

    .back-btn:hover {
      background: #d0d7de;
    }

    .back-btn:active {
      transform: scale(0.97);
    }

    label {
      display: block;
      margin-top: 15px;
      margin-bottom: 5px;
      font-weight: 600;
      font-size: 0.95rem;
      color: #2c3e50;
    }

    input,
    select {
      width: 100%;
      padding: 10px 12px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 0.95rem;
      transition: border 0.2s, box-shadow 0.2s;
    }

    input:focus,
    select:focus {
      outline: none;
      border-color: #3498db;
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.25);
    }

    button[type="submit"] {
      margin-top: 20px;
      width: 100%;
      padding: 12px 20px;
      background: #3498db;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      transition: background 0.25s, transform 0.1s;
    }

    button[type="submit"]:hover {
      background: #2980b9;
    }

    button[type="submit"]:active {
      transform: scale(0.98);
    }

    .error {
      color: #e74c3c;
      margin-top: 12px;
      font-weight: 600;
      font-size: 0.9rem;
      text-align: center;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(15px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
  </style>
</head>

<body>

  <form id="editConnectorForm">
    <div class="form-header">
      <h1>Edit Connector - {{ connector.get('name', '') }}</h1>
      <button type="button" class="back-btn" onclick="window.location.href='/projects/{{ project_id }}/connectors'">⬅ Back</button>
    </div>

    <p id="error-msg" class="error" style="display:none;"></p>

    <label>Name</label>
    <input type="text" id="name" value="{{ connector.get('name', '') }}" required>

    <label>Description</label>
    <input type="text" id="description" value="{{ connector.get('description', '') }}">

    <label>GitHub Repo URL</label>
    <input type="text" id="repo_url" value="{{ connector.spec.url }}" required>

    <label>Username</label>
    <input type="text" id="username" value="{{ connector.spec.username }}" required>

    <label>GitHub Token (Secret)</label>
    <select id="token_ref" name="token_ref" required>
      <option value="" disabled {% if not connector.spec.password_ref %}selected{% endif %}>-- Select Secret --</option>
      {% for s in secrets %}
      <option value="{{ s.identifier }}" {% if s.identifier==connector.spec.password_ref %}selected{% endif %}>{{ s.name }}</option>
      {% endfor %}
    </select>

    <button type="submit">Update Connector</button>
  <script>
    const initialData = {
      name: "{{ connector.get('name', '') }}",
      description: "{{ connector.get('description', '') }}",
      repo_url: "{{ connector.spec.url }}",
      username: "{{ connector.spec.username }}",
      passwordRef: "{{ connector.spec.password_ref }}",
      type: "{{ connector.spec.type }}", // mandatory
      authType: "{{ connector.spec.authentication.type if connector.spec.authentication else 'Http' }}" // mandatory
    };

    const form = document.getElementById("editConnectorForm");
    const errorMsg = document.getElementById("error-msg");

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      errorMsg.style.display = "none";

      const currentData = {
        name: document.getElementById("name").value.trim(),
        description: document.getElementById("description").value.trim(),
        repo_url: document.getElementById("repo_url").value.trim(),
        username: document.getElementById("username").value.trim(),
        passwordRef: document.getElementById("token_ref").value.trim()
      };

      if (!currentData.username || !currentData.passwordRef) {
        errorMsg.textContent = "⚠️ Username and GitHub token must be selected.";
        errorMsg.style.display = "block";
        return;
      }

      // Prepare payload with mandatory type fields
      const payload = {
        spec: {
          type: initialData.type,
          url: currentData.repo_url !== initialData.repo_url ? currentData.repo_url : initialData.repo_url,
          authentication: {
            type: initialData.authType,
            spec: {
              username: currentData.username !== initialData.username ? currentData.username : initialData.username,
              passwordRef: currentData.passwordRef !== initialData.passwordRef ? currentData.passwordRef : initialData.passwordRef
            }
          }
        }
      };

      if (currentData.name !== initialData.name) payload.name = currentData.name;
      if (currentData.description !== initialData.description) payload.description = currentData.description;

      try {
        const res = await fetch(window.location.pathname, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ connector: payload })
        });

        const data = await res.json();

        if (res.ok) {
          alert("Connector updated successfully!");
          window.location.href = `/projects/{{ project_id }}/connectors`;
        } else {
          errorMsg.textContent = "⚠️ Error: " + (data.error || JSON.stringify(data));
          errorMsg.style.display = "block";
        }
      } catch (err) {
        errorMsg.textContent = "⚠️ Request failed: " + err.message;
        errorMsg.style.display = "block";
      }
    });
  </script>

</body>

</html>