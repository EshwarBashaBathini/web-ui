<!DOCTYPE html>
<html>

<head>
    <title>Harness Project & Pipeline</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        /* ===== Harness UI Inspired Base Styles ===== */
        *,
        *::before,
        *::after {
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(120deg, #f0f4f8, #d9e2ec);
            color: #1f3c88;
            font-weight: 500;
            min-height: 100vh;
        }

        h2 {
            text-align: center;
            font-size: 2em;
            margin-bottom: 30px;
            color: #1f3c88;
            user-select: none;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 6px;
            color: #475569;
        }

        input,
        select,
        textarea,
        button {
            padding: 10px 14px;
            font-size: 1em;
            border-radius: 8px;
            border: 1px solid #cbd5e1;
            outline: none;
            width: 100%;
            transition: all 0.3s ease;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-weight: 500;
        }

        input:focus,
        select:focus,
        textarea:focus {
            border-color: #3de9b2;
            box-shadow: 0 0 8px rgba(61, 233, 178, 0.5);
        }

        button {
            cursor: pointer;
            border: none;
            background-color: #3498db;
            /* Harness blue */
            color: white;
            font-weight: 600;
            margin-top: 8px;
            box-shadow: 0 2px 8px rgba(52, 152, 219, 0.4);
            transition: background-color 0.3s ease, box-shadow 0.3s ease, transform 0.2s ease;
            border-radius: 8px;
            user-select: none;
        }

        button:hover:not(:disabled) {
            background-color: #2c80b4;
            /* darker blue */
            box-shadow: 0 6px 20px rgba(28, 103, 176, 0.5);
            transform: translateY(-2px);
        }

        button:disabled {
            background-color: #94a3b8;
            cursor: not-allowed;
            box-shadow: none;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin: 20px auto;
            max-width: 700px;
            box-shadow: 0 8px 24px rgb(61 233 178 / 0.24);
        }

        .field-group {
            margin-bottom: 18px;
        }

        .form-container {
            display: none;
            padding: 20px;
            border-radius: 12px;
            background: #f0fdfa;
            box-shadow: 0 8px 24px rgb(61 233 178 / 0.16);
            animation: fadeIn 0.4s ease-in-out;
            margin-top: 20px;
        }

        .form-container.show {
            display: block;
        }

        .error {
            color: #ef4444;
            font-size: 0.95em;
            margin-top: 5px;
            user-select: none;
        }

        h2 {
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
        }

        #pipeline-container {
            display: none;
        }

        .stage-block,
        .step-block {
            background: #f9fff9;
            border: 1px solid #3de9b2;
            padding: 15px;
            margin-bottom: 12px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgb(61 233 178 / 0.3);
            position: relative;
            user-select: none;
        }

        .stage-block {
            border-left: 6px solid #3de9b2;
            margin-top: 20px;
        }

        .step-block {
            border-left: 6px solid #22c55e;
            margin-top: 12px;
        }

        /* ===== Button Group for stages/steps ===== */
        .btn-delete,
        .btn-clear {
            position: absolute;
            top: 8px;
            font-size: 12px;
            padding: 4px 10px;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            min-width: unset;
            user-select: none;
            transition: background-color 0.3s ease;
            width: auto;
        }

        .btn-delete {
            background: #ef4444;
            right: 8px;
        }

        .btn-delete:hover {
            background: #b91c1c;
        }

        .btn-clear {
            background: #3498db;
            right: 50px;
        }

        .btn-clear:hover {
            background: #2c80b4;
        }

        /* Add buttons style */
        .btn-add {
            display: inline-block;
            margin-top: 20px;
            /* increased margin for gap below previous content */
            padding: 8px 16px;
            /* slightly bigger padding */
            background: #3498db;
            color: white;
            font-size: 16px;
            font-weight: 600;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            user-select: none;
            transition: background-color 0.3s ease;
        }

        .btn-add:hover {
            background: #2c80b4;
        }

        /* Center Create Pipeline and similar buttons */
        .btn-group {
            display: flex;
            justify-content: center;
            gap: 12px;
            flex-wrap: wrap;
            margin-top: 12px;
        }

        /* Centered full width View Pipeline button */
        .inline-btn {
            display: inline-block;
            vertical-align: middle;
            cursor: pointer;
            font-weight: 600;
            color: white;
            border-radius: 8px;
            padding: 12px 20px;
            background-color: #3498db;
            border: none;
            user-select: none;
            transition: background-color 0.3s ease;
            width: 100%;
            max-width: 360px;
            margin: 20px auto 10px auto;
            /* margin auto left and right to center block */
            text-align: center;
            box-sizing: border-box;
        }

        .inline-btn:hover {
            background-color: #2c80b4;
        }

        /* Loader */
        .loader {
            display: inline-block;
            width: 18px;
            height: 18px;
            border: 3px solid rgba(61, 233, 178, 0.3);
            border-top: 3px solid #3de9b2;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-left: 10px;
            vertical-align: middle;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        @keyframes fadeIn {
            0% {
                opacity: 0;
                transform: translateY(-10px);
            }

            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ===== Responsive ===== */
        @media (max-width: 768px) {
            .card {
                padding: 20px;
                margin: 15px;
                max-width: 95vw;
            }
        }

        @media (max-width: 576px) {
            body {
                padding: 10px;
            }

            h2 {
                font-size: 1.6em;
            }

            input,
            select,
            textarea,
            button {
                font-size: 0.95em;
                padding: 8px 10px;
            }

            .btn-group {
                flex-direction: column;
            }

            .inline-btn {
                max-width: 100%;
                margin-left: 0;
                margin-right: 0;
            }
        }
    </style>
</head>

<body>
    <h2>Select Project and Pipeline</h2>

    <!-- Project Section -->
    <div class="card">
        <div class="field-group">
            <label for="project">Project:</label>
            <select id="project" name="project" onchange="onProjectChange()">
                <option value="" selected>--Select Project--</option>
                {% for project in projects %}
                <option value="{{ project.identifier }}">{{ project.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="btn-group">
            <button type="button" class="inline-btn" id="create-project-btn" onclick="showCreateProjectForm()">Create Project</button>
        </div>

        <div id="create-project-form" class="form-container">
            <div class="field-group">
                <label>Project Name:</label>
                <input type="text" name="new_project_name" required>
            </div>
            <div class="field-group">
                <label>Project Identifier:</label>
                <input type="text" name="new_project_id" required>
            </div>
            <div class="btn-group">
                <button type="button" onclick="createProject()">Create Project</button>
                <button type="button" onclick="cancelCreateProject()" style="
        background-color:#e74c3c;
        color:#fff;
        border:none;
        padding:8px 16px;
        font-size:14px;
        font-weight:bold;
        border-radius:4px;
        cursor:pointer;
        transition:background-color 0.3s ease;
    " onmouseover="this.style.backgroundColor='#c0392b'" onmouseout="this.style.backgroundColor='#e74c3c'">
                    Cancel
                </button>

            </div>
        </div>
    </div>

    <!-- Pipeline Section -->
    <div id="pipeline-container" class="card">
        <div class="field-group">
            <label for="pipeline">Pipeline:</label>
            <select id="pipeline" name="pipeline" onchange="onPipelineChange()">
                <option value="" selected>--Select pipeline--</option>
                {% for pipeline in pipelines %}
                <option value="{{ pipeline.identifier }}">{{ pipeline.name }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="btn-group">
            <button type="button" class="inline-btn" id="create-pipeline-btn" onclick="showCreatePipelineForm()">Create Pipeline</button>
        </div>

        <div id="create-pipeline-form" class="form-container">
            <div class="field-group">
                <label>Pipeline Name:</label>
                <input type="text" id="new_pipeline_name" required>
            </div>

            <!-- New scope selection -->
            <div class="field-group">
                <label>Connector Scope:</label>
                <select id="connector_scope" onchange="loadConnectors()" required>
                    <option value="" disabled selected>--Select Scope--</option>
                    <option value="account">Account</option>
                    <option value="org">Organization</option>
                    <option value="project">Project</option>
                </select>
            </div>

            <div class="field-group">
                <label>Connector:</label>
                <select id="connector_select" required onchange="handleConnectorChange(event)">
                    <option value="" disabled selected>--Select Connector--</option>
                </select>
                <span id="connector-loader" class="loader" style="display:none;"></span>
            </div>
            <div class="field-group">
                <label>Repository Name:</label>
                <input type="text" id="repo_name" placeholder="my-repo" required>
            </div>
            <div class="field-group">
                <label>Git Branch:</label>
                <input type="text" id="git_branch" placeholder="main" required>
            </div>

            <h3>Stages</h3>
            <div id="stages"></div>
            <button type="button" class="btn-add" onclick="addStage()">+ Add Stage</button>

            <div class="btn-group" style="margin-top:18px">
                <button type="button" onclick="createPipeline()">Create Pipeline</button>
                <button type="button" onclick="cancelCreatePipeline()" style="
        background-color:#e74c3c;
        color:#fff;
        border:none;
        padding:8px 16px;
        font-size:14px;
        font-weight:bold;
        border-radius:4px;
        cursor:pointer;
        transition:background-color 0.3s ease;
    " onmouseover="this.style.backgroundColor='#c0392b'" onmouseout="this.style.backgroundColor='#e74c3c'">
                    Cancel
                </button>

            </div>
        </div>


    </div>

    <div style="display: flex; justify-content: center; margin-top: 20px;">
        <button id="view-pipeline-btn" type="button" class="inline-btn narrow-btn" style="display:none;"
            onclick="viewPipeline()">
            View Pipeline
        </button>
    </div>

    <script>
        // ===== Dynamic Stages and Steps =====
        let stageCount = 0;

        function addStage() {
            const stageId = `stage-${stageCount++}`;
            const html = `
        <div class="stage-block" id="${stageId}" style="position: relative;">
            <button type="button" class="btn-delete" onclick="deleteStage('${stageId}')">×</button>
            <button type="button" class="btn-clear" onclick="clearStage('${stageId}')">Clear</button>
            <div class="field-group">
                <label>Stage Name:</label>
                <input type="text" name="stage_name" placeholder="Build Stage" required>
            </div>
            <div class="steps"></div>
            <button type="button" class="btn-add" onclick="addStep('${stageId}')">+ Add Step</button>
        </div>`;
            document.getElementById("stages").insertAdjacentHTML('beforeend', html);
        }

        function deleteStage(id) {
            const el = document.getElementById(id);
            if (el) el.remove();
        }

        function clearStage(stageId) {
            const stageBlock = document.getElementById(stageId);
            if (!stageBlock) return;
            stageBlock.querySelectorAll('input, select, textarea').forEach(el => {
                el.value = '';
            });
        }

        function addStep(stageId) {
            const container = document.getElementById(stageId).querySelector(".steps");
            const stepId = `step-${Date.now()}`;
            const html = `
      <div class="step-block" id="${stepId}">
        <div class="field-group">
          <label>Step Name:</label>
          <input type="text" name="step_name" placeholder="Enter step name" required>
        </div>
        <div class="field-group">
          <label>Step Type:</label>
          <select name="step_type">
            <option value="Run">Run</option>
            <option value="Plugin">Plugin</option>
          </select>
        </div>
        <div class="field-group">
          <label>Shell:</label>
          <select name="shell" onchange="toggleCommandField('${stepId}', this.value)" required>
            <option value="">Select Shell</option>
            <option value="powershell">PowerShell</option>
            <option value="bash">Bash</option>
            <option value="python">Python</option>
          </select>
        </div>
        <div class="field-group command-field" style="display:none;">
          <label>Command:</label>
          <textarea name="command" placeholder="Enter command script here..." rows="6" required></textarea>
        </div>
        <button type="button" class="btn-delete" onclick="document.getElementById('${stepId}').remove()">Delete Step</button>
      </div>`;
            container.insertAdjacentHTML('beforeend', html);
        }

        function toggleCommandField(stepId, shellValue) {
            const stepBlock = document.getElementById(stepId);
            if (!stepBlock) return;
            const commandField = stepBlock.querySelector('.command-field');
            if (!commandField) return;
            commandField.style.display = shellValue ? 'block' : 'none';
        }

        // handle connector change (debug)
        function handleConnectorChange(e) {
            console.log("Connector selected:", e.target.value);
        }

        // ===== Form helpers =====
        function resetPipelineForm() {
            const form = document.getElementById("create-pipeline-form");
            if (!form) return;
            form.querySelectorAll('input, select, textarea').forEach(el => {
                // keep connector scope default placeholder untouched if present
                if (el.id === 'connector_scope') {
                    el.selectedIndex = 0;
                } else if (el.tagName.toLowerCase() === 'select') {
                    el.selectedIndex = 0;
                } else {
                    el.value = '';
                }
            });
            const stagesContainer = document.getElementById("stages");
            if (stagesContainer) stagesContainer.innerHTML = '';
            const connectorSelect = document.getElementById("connector_select");
            if (connectorSelect) {
                connectorSelect.disabled = false;
                connectorSelect.innerHTML = "<option value=\"\" disabled selected>--Select Connector--</option>";
            }
        }

        function showCreatePipelineForm() {
            const createForm = document.getElementById("create-pipeline-form");
            const pipelineSelect = document.getElementById("pipeline");
            const createBtn = document.getElementById("create-pipeline-btn");

            // Reset form before showing
            resetPipelineForm();

            // Show form and hide pipeline select & create button
            createForm.classList.add("show");
            pipelineSelect.style.display = "none";
            if (createBtn) createBtn.style.display = "none";

            // hide view button while creating
            document.getElementById("view-pipeline-btn").style.display = "none";

            // Load connectors (since form is open)
            // do not block UI — loadConnectors will check connector_scope value
            loadConnectors();
        }

        function cancelCreatePipeline() {
            const form = document.getElementById("create-pipeline-form");
            const pipelineSelect = document.getElementById("pipeline");
            const createBtn = document.getElementById("create-pipeline-btn");

            form.classList.remove("show");
            pipelineSelect.style.display = "inline-block";
            if (createBtn) createBtn.style.display = "inline-block";

            // Reset form contents
            resetPipelineForm();

            // update visible buttons according to selection
            updatePipelineButtons();
        }

        // ===== Connectors fetch =====
        async function loadConnectors() {
            const scope = document.getElementById("connector_scope").value;
            const projectId = document.getElementById("project").value;
            const connectorSelect = document.getElementById("connector_select");
            const loader = document.getElementById("connector-loader");

            connectorSelect.innerHTML = "<option disabled selected>Loading...</option>";
            connectorSelect.disabled = true;
            loader.style.display = "inline-block";

            if (!scope) {
                loader.style.display = "none";
                connectorSelect.innerHTML = "<option disabled selected>--Select Connector--</option>";
                return;
            }

            try {
                let url = "";
                if (scope === "account") {
                    url = `/connectors/account`;
                } else if (scope === "org") {
                    url = `/connectors/org`;
                } else if (scope === "project") {
                    if (!projectId) {
                        alert("Please select a project first for project-level connectors.");
                        loader.style.display = "none";
                        connectorSelect.innerHTML = "<option disabled selected>--Select Connector--</option>";
                        return;
                    }
                    url = `/connectors/project/${projectId}`;
                }

                const res = await fetch(url);
                const connectors = await res.json();

                connectorSelect.innerHTML = "<option value='' disabled selected>--Select Connector--</option>";

                if (!connectors || connectors.length === 0) {
                    const noOption = document.createElement("option");
                    noOption.textContent = "No connectors found";
                    noOption.disabled = true;
                    connectorSelect.appendChild(noOption);
                } else {
                    connectors.forEach(c => {
                        const opt = document.createElement("option");
                        opt.value = c.identifier || c.id || c.name || "";
                        opt.textContent = c.name || c.identifier || "Unnamed Connector";
                        connectorSelect.appendChild(opt);
                    });
                }

                connectorSelect.disabled = false;
            } catch (err) {
                console.error("Error fetching connectors:", err);
                connectorSelect.innerHTML = "<option disabled>Error loading connectors</option>";
                connectorSelect.disabled = true;
            } finally {
                loader.style.display = "none";
            }
        }

        // ===== Create pipeline AJAX =====
        async function createPipeline() {
            const projectId = (document.getElementById("project")?.value || "").trim();
            const name = (document.getElementById("new_pipeline_name")?.value || "").trim();
            const connectorSelect = document.getElementById("connector_select");
            const connectorRefRaw = connectorSelect ? connectorSelect.value.trim() : "";
            const connectorRef = connectorRefRaw && connectorRefRaw !== "undefined" ? connectorRefRaw : "";
            const connectorScopeRaw = (document.getElementById("connector_scope")?.value || "account").trim();
            const connectorScope = connectorScopeRaw || "account";
            const repoName = (document.getElementById("repo_name")?.value || "").trim();
            const gitBranch = (document.getElementById("git_branch")?.value || "").trim();

            if (!projectId || !name || !connectorRef || !repoName || !gitBranch) {
                alert("All required fields must be filled. Ensure you select a connector.");
                return;
            }

            const stages = [];
            document.querySelectorAll(".stage-block").forEach(stageBlock => {
                const stageName = (stageBlock.querySelector("input[name='stage_name']")?.value || "").trim();
                if (!stageName) return;
                const steps = [];
                stageBlock.querySelectorAll(".step-block").forEach(stepBlock => {
                    const stepName = (stepBlock.querySelector("input[name='step_name']")?.value || "").trim();
                    const stepType = (stepBlock.querySelector("select[name='step_type']")?.value || "").trim();
                    const shell = (stepBlock.querySelector("select[name='shell']")?.value || "").trim();
                    const command = (stepBlock.querySelector("textarea[name='command']")?.value || "").trim();
                    if (stepName && stepType && shell && command) {
                        steps.push({ step_name: stepName, step_type: stepType, shell, command });
                    }
                });
                if (steps.length > 0) stages.push({ stage_name: stageName, steps });
            });

            if (stages.length === 0) {
                alert("Please add at least one stage with valid steps.");
                return;
            }

            try {
                const res = await fetch("/create_pipeline_ajax", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        project_id: projectId,
                        name,
                        connectorRef,
                        connector_scope: connectorScope,
                        repoName,
                        gitBranch,
                        stages
                    })
                });

                const data = await res.json();
                if (res.ok) {
                    // Refresh pipeline list and select the new pipeline
                    await loadPipelines(projectId, data.pipelineIdentifier);
                    // hide form and show selection UI
                    cancelCreatePipeline();
                } else {
                    alert("Error creating pipeline: " + (data.error || "Unknown error"));
                }
            } catch (err) {
                alert("Request failed: " + err.message);
            }
        }

        // ===== Load pipelines for selected project =====
        async function loadPipelines(projectId, selectPipelineId = null) {
            const pipelineSelect = document.getElementById("pipeline");
            pipelineSelect.innerHTML = "<option value='' selected>Loading...</option>";
            pipelineSelect.disabled = true;

            try {
                const res = await fetch(`/pipelines/${projectId}`);
                const pipelines = await res.json();

                pipelineSelect.innerHTML = "";

                const defaultOption = document.createElement("option");
                defaultOption.value = "";
                defaultOption.textContent = "--Select Pipeline--";
                defaultOption.selected = true;
                defaultOption.disabled = true;
                pipelineSelect.appendChild(defaultOption);

                if (!pipelines || pipelines.length === 0) {
                    const noOption = document.createElement("option");
                    noOption.textContent = "No pipelines found";
                    noOption.disabled = true;
                    pipelineSelect.appendChild(noOption);
                } else {
                    pipelines.forEach(p => {
                        const opt = document.createElement("option");
                        // support both id or identifier depending on API
                        opt.value = p.id || p.identifier || p.pipelineIdentifier || p.name;
                        opt.textContent = p.name || p.identifier || p.pipelineIdentifier || "Unnamed Pipeline";
                        pipelineSelect.appendChild(opt);
                    });
                }

                // if a pipeline id is provided to auto-select, try to select it
                if (selectPipelineId) {
                    const optionToSelect = Array.from(pipelineSelect.options).find(o => o.value === selectPipelineId);
                    if (optionToSelect) {
                        optionToSelect.selected = true;
                    } else {
                        // if not found, append and select
                        const opt = document.createElement("option");
                        opt.value = selectPipelineId;
                        opt.textContent = selectPipelineId;
                        opt.selected = true;
                        pipelineSelect.appendChild(opt);
                    }
                }

                pipelineSelect.disabled = false;
                updatePipelineButtons();
            } catch (err) {
                pipelineSelect.innerHTML = "<option disabled>Error loading pipelines</option>";
                pipelineSelect.disabled = true;
                console.error("Error loading pipelines:", err);
            }
        }

        // ===== UI update helpers =====
        function updatePipelineButtons() {
            const projectSelect = document.getElementById("project");
            const pipelineSelect = document.getElementById("pipeline");
            const createPipelineBtn = document.getElementById("create-pipeline-btn");
            const viewBtn = document.getElementById("view-pipeline-btn");

            if (projectSelect.value && pipelineSelect.value) {
                if (createPipelineBtn) createPipelineBtn.style.display = "none";
                if (viewBtn) viewBtn.style.display = "inline-block";
            } else if (projectSelect.value && !pipelineSelect.value) {
                if (createPipelineBtn) createPipelineBtn.style.display = "inline-block";
                if (viewBtn) viewBtn.style.display = "none";
            } else {
                if (createPipelineBtn) createPipelineBtn.style.display = "none";
                if (viewBtn) viewBtn.style.display = "none";
            }
        }

        // Called when a user picks a project from the dropdown
        function onProjectChange() {
            const projectSelect = document.getElementById("project");
            const pipelineContainer = document.getElementById("pipeline-container");

            // hide create pipeline form if open
            const createForm = document.getElementById("create-pipeline-form");
            if (createForm) createForm.classList.remove("show");

            // show pipeline container only when a project is selected
            if (projectSelect.value) {
                pipelineContainer.style.display = "block";
                loadPipelines(projectSelect.value);
            } else {
                pipelineContainer.style.display = "none";
            }

            // hide create project button when project selected
            toggleCreateProjectBtn();
            updatePipelineButtons();
        }

        // Called when pipeline dropdown changes
        function onPipelineChange() {
            updatePipelineButtons();
        }

        // ===== Create project flows =====
        function showCreateProjectForm() {
            const form = document.getElementById("create-project-form");
            if (!form) return;
            form.classList.add("show");
            document.getElementById("project").style.display = "none";
            const btn = document.getElementById("create-project-btn");
            if (btn) btn.style.display = "none";
            form.querySelectorAll('input').forEach(input => input.value = '');
        }

        function cancelCreateProject() {
            const form = document.getElementById("create-project-form");
            if (!form) return;
            form.classList.remove("show");
            document.getElementById("project").style.display = "inline-block";
            const btn = document.getElementById("create-project-btn");
            if (btn) btn.style.display = "inline-block";
            toggleCreateProjectBtn();
        }

        async function createProject() {
            const name = document.querySelector('#create-project-form input[name="new_project_name"]').value;
            const identifier = document.querySelector('#create-project-form input[name="new_project_id"]').value;
            if (!name || !identifier) { alert("Project Name and ID required"); return; }

            const res = await fetch("/create_project_ajax", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ name, identifier })
            });
            const data = await res.json();

            if (res.ok) {
                const projectSelect = document.getElementById("project");
                const opt = document.createElement("option");
                opt.value = data.identifier;
                opt.textContent = data.name;
                opt.selected = true;
                projectSelect.appendChild(opt);
                cancelCreateProject();
                document.getElementById("pipeline-container").style.display = "block";
                await loadPipelines(data.identifier);
            } else {
                alert("Error creating project: " + data.error);
            }
        }

        function toggleCreateProjectBtn() {
            const projectSelect = document.getElementById("project");
            const btn = document.getElementById("create-project-btn");
            const formVisible = document.getElementById("create-project-form").classList.contains("show");
            if (!btn) return;
            btn.style.display = (projectSelect.value === "" && !formVisible) ? "inline-block" : "none";
        }

        // View pipeline button handler
        function viewPipeline() {
            const projectId = document.getElementById("project").value;
            const pipelineId = document.getElementById("pipeline").value;
            if (!projectId || !pipelineId) {
                alert("Please select both project and pipeline.");
                return;
            }
            window.location.href = `/projects/${projectId}/pipelines/${pipelineId}`;
        }

        // -------------- NEW: auto-select project when page loaded from /projects/<id>/pipelines/create --------------
        document.addEventListener("DOMContentLoaded", () => {
            try {
                // path match: /projects/<project_id>/pipelines/create or /projects/<project_id>/pipelines/create?...
                const pathMatch = window.location.pathname.match(/\/projects\/([^\/]+)\/pipelines\/create\/?$/);
                const qProject = new URLSearchParams(window.location.search).get("project_id");
                const projectIdFromUrl = pathMatch ? decodeURIComponent(pathMatch[1]) : (qProject || null);

                if (projectIdFromUrl) {
                    const projectSelect = document.getElementById("project");

                    // try to find existing option
                    let opt = Array.from(projectSelect.options).find(o => o.value === projectIdFromUrl || o.text === projectIdFromUrl);

                    // if option not found, add it (useful if server didn't render the projects list)
                    if (!opt) {
                        opt = document.createElement("option");
                        opt.value = projectIdFromUrl;
                        opt.textContent = projectIdFromUrl;
                        projectSelect.appendChild(opt);
                    }

                    // select and trigger change logic to load pipelines and show UI
                    opt.selected = true;

                    // call onProjectChange to show pipeline container and load pipelines
                    onProjectChange();

                    // If you want the create form to auto-open, set autoOpen = true
                    const autoOpen = false; // <- change to true if you want form auto-open
                    if (autoOpen) {
                        // small delay so loadPipelines can populate before opening form
                        setTimeout(() => {
                            showCreatePipelineForm();
                            const formEl = document.getElementById("create-pipeline-form");
                            if (formEl) formEl.scrollIntoView({ behavior: "smooth", block: "center" });
                        }, 500);
                    }
                }
            } catch (err) {
                console.error("Auto-select project failed:", err);
            }
        });
        // -----------------------------------------------------------------------------------------------
    </script>

</body>

</html>
